<html>
<head>
<meta charset="UTF-8">
<style type="text/css">
    div.histo {
        visibility: hidden
    }
</style>

<!--Load the AJAX API-->
<script type="text/javascript" src="https://www.google.com/jsapi"></script>

<script type="text/javascript">

    if (window.File && window.FileReader && window.FileList && window.Blob) {
        // Great success! All the File APIs are supported.
    } else {
        alert('The File APIs are not fully supported in this browser.');
    }

    // Load the Visualization API and the corechart package.
    google.load('visualization', '1.0', {'packages':['corechart']});

    // Set a callback to run when the Google Visualization API is loaded.
    google.setOnLoadCallback(drawInitialChart);

    var chartData = null;
    var chart = null;

    function setChartData(names, histos) {
        while (names.length < histos.length) {
            names.push('Unknown');
        }

        var series = [];
        for (var i = 0; i < histos.length; i++) {
            series = appendDataSeries(histos[i], names[i], series);
        }

        chartData = google.visualization.arrayToDataTable(series);
    }


    function drawInitialChart() {
        // Connect the choose files button:
        document.getElementById('files').addEventListener('change', handleFileSelect, false);

        // Load some static example data:
        var data1Str = document.querySelector("div#data_1").innerHTML.trim();
        var data2Str = document.querySelector("div#data_2").innerHTML.trim();
        var data3Str = document.querySelector("div#data_3").innerHTML.trim();
        var histos = [data1Str, data2Str, data3Str];
        var names = ['A', 'B', 'C'];

        setChartData(names, histos);
        drawChart();
    }

    var maxPercentile = 1000;

    function drawChart() {

        var ticks =
                [{v:1,f:'0%'},
                    {v:10,f:'90%'},
                    {v:100,f:'99%'},
                    {v:1000,f:'99.9%'},
                    {v:10000,f:'99.99%'},
                    {v:100000,f:'99.999%'},
                    {v:1000000,f:'99.9999%'},
                    {v:10000000,f:'99.99999%'},
                    {v:100000000,f:'99.999999%'}];

        var unitSelection = document.getElementById("timeUnitSelection");
        var unitSelIndex = unitSelection.selectedIndex;
        var unitText = unitSelection.options[unitSelIndex].innerHTML;

        var options = {
            title: 'Latency by Percentile Distribution',
            height: 480,
//            hAxis: {title: 'Percentile', minValue: 0, logScale: true, ticks:ticks },
            hAxis: {
                title: "Percentile",
                minValue: 1, logScale: true, ticks:ticks,
                viewWindowMode:'explicit',
                viewWindow:{
                    max:maxPercentile,
                    min:1
                }
            },
            vAxis: {title: 'Latency (' + unitText + ')', minValue: 0 },
            legend: {position: 'bottom'}
        };

        if (chart == null) {
            chart = new google.visualization.LineChart(document.getElementById('chart_div'));
        }

        // add tooltips with correct percentile text to data:
        var columns = [0];
        for (var i = 1; i < chartData.getNumberOfColumns(); i++) {
            columns.push(i);
            columns.push({
                type: 'string',
                properties: {
                    role: 'tooltip'
                },
                calc: (function (j) {
                    return function (dt, row) {
                        var percentile = 100.0 - (100.0/dt.getValue(row, 0));
                        return dt.getColumnLabel(j) + ': ' +
                                percentile.toPrecision(7) +
                                '\%\'ile = ' + dt.getValue(row, j) + ' ' + unitText
                    }
                })(i)
            });
        }
        var view = new google.visualization.DataView(chartData);
        view.setColumns(columns);

        chart.draw(view, options);

    }
</script>
<script type="text/javascript">
    function appendDataSeries(histo, name, dataSeries) {
        var series;
        var seriesCount;
        if (dataSeries.length == 0) {
            series = [ ['X', name] ];
            seriesCount = 1;
        } else {
            series = dataSeries;
            series[0].push(name);
            seriesCount = series[0].length - 1;
        }

        var lines = histo.split("\n");

        var seriesIndex = 1;
        for (var i = 0; i < lines.length; i++) {
            var line = lines[i].trim();
            var values = line.trim().split(/[ ]+/);

            if (line[0] != '#' && values.length == 4) {

                var y = parseFloat(values[0]);
                var x = parseFloat(values[3]);

                if (!isNaN(x) && !isNaN(y)) {

                    if (seriesIndex >= series.length) {
                        series.push([x]);
                    }

                    while (series[seriesIndex].length < seriesCount) {
                        series[seriesIndex].push(null);
                    }

                    series[seriesIndex].push(y);
                    seriesIndex++;
                }
            }
        }

        while (seriesIndex < series.length) {
            series[seriesIndex].push(null);
            seriesIndex++;
        }

        return series;
    }
</script>
<script>
    function timeUnitsSelected(evt) {
        drawChart();
        return {typed: ''};
    }

    function doExport(event) {
        saveSvgAsPng(document.querySelector('svg'), 'Histogram', 2.0);
        return {typed: ''};
    }
</script>

<script>
    function handleFileSelect(evt) {
        var files = evt.target.files; // FileList object
        var fileDisplayArea = document.getElementById('fileDisplayArea');

        var names = [];
        var histos = [];

        fileDisplayArea.innerText = "file selected...\n";

        // Loop through the FileList and render image files as thumbnails.
        for (var i = 0, f; f = files[i]; i++) {
            var reader = new FileReader();

            reader.onload = (function(theFile) {
                return function(e) {
                    histos.push(e.target.result);
                    names.push(escape(theFile.name));
                    fileDisplayArea.innerText = " Plotting input from: " + names + "\n";
                    setChartData(names, histos);
                    drawChart();
                };
            })(f);

            // Read in the image file as a data URL.
            reader.readAsText(f);
        }

    }

</script>

<script type="text/javascript">
    (function() {
        var out$ = typeof exports != 'undefined' && exports || this;

        var doctype = '<?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">';

        function inlineImages(callback) {
            var images = document.querySelectorAll('svg image');
            var left = images.length;
            if (left == 0) {
                callback();
            }
            for (var i = 0; i < images.length; i++) {
                (function(image) {
                    if (image.getAttribute('xlink:href')) {
                        var href = image.getAttribute('xlink:href').value;
                        if (/^http/.test(href) && !(new RegExp('^' + window.location.host).test(href))) {
                            throw new Error("Cannot render embedded images linking to external hosts.");
                        }
                    }
                    var canvas = document.createElement('canvas');
                    var ctx = canvas.getContext('2d');
                    var img = new Image();
                    img.src = image.getAttribute('xlink:href');
                    img.onload = function() {
                        canvas.width = img.width;
                        canvas.height = img.height;
                        ctx.drawImage(img, 0, 0);
                        image.setAttribute('xlink:href', canvas.toDataURL('image/png'));
                        left--;
                        if (left == 0) {
                            callback();
                        }
                    }
                })(images[i]);
            }
        }

        function styles(dom) {
            var css = "";
            var sheets = document.styleSheets;
            for (var i = 0; i < sheets.length; i++) {
                if (sheets[i].hasOwnProperty('cssRules')) {
                    var rules = sheets[i].cssRules;
                    for (var j = 0; j < rules.length; j++) {
                        var rule = rules[j];
                        if (typeof(rule.style) != "undefined") {
                            css += rule.selectorText + " { " + rule.style.cssText + " }\n";
                        }
                    }
                }
            }

            var s = document.createElement('style');
            s.setAttribute('type', 'text/css');
            s.innerHTML = "<![CDATA[\n" + css + "\n]]>";

            var defs = document.createElement('defs');
            defs.appendChild(s);
            return defs;
        }

        out$.svgAsDataUri = function(el, scaleFactor, cb) {
            scaleFactor = scaleFactor || 1;

            inlineImages(function() {
                var outer = document.createElement("div");
                var clone = el.cloneNode(true);
                var width = parseInt(
                        clone.getAttribute('width')
                        || clone.style.width
                        || out$.getComputedStyle(el).getPropertyValue('width')
                );
                var height = parseInt(
                        clone.getAttribute('height')
                        || clone.style.height
                        || out$.getComputedStyle(el).getPropertyValue('height')
                );

                var xmlns = "http://www.w3.org/2000/xmlns/";

                clone.setAttribute("version", "1.1");
                clone.setAttributeNS(xmlns, "xmlns", "http://www.w3.org/2000/svg");
                clone.setAttributeNS(xmlns, "xmlns:xlink", "http://www.w3.org/1999/xlink");
                clone.setAttribute("width", width * scaleFactor);
                clone.setAttribute("height", height * scaleFactor);
                clone.setAttribute("viewBox", "0 0 " + width + " " + height);
                outer.appendChild(clone);

                clone.insertBefore(styles(clone), clone.firstChild);

                var svg = doctype + outer.innerHTML;
                var uri = 'data:image/svg+xml;base64,' + window.btoa(unescape(encodeURIComponent(svg)));
                if (cb) {
                    cb(uri);
                }
            });
        }

        out$.saveSvgAsPng = function(el, name, scaleFactor) {
            out$.svgAsDataUri(el, scaleFactor, function(uri) {
                var image = new Image();
                image.src = uri;
                image.onload = function() {
                    var canvas = document.createElement('canvas');
                    canvas.width = image.width;
                    canvas.height = image.height;
                    var context = canvas.getContext('2d');
                    context.drawImage(image, 0, 0);

                    var a = document.createElement('a');
                    a.download = name;
                    a.href = canvas.toDataURL('image/png');
                    document.body.appendChild(a);
                    a.click();
                }
            });
        }
    })();
</script>

<style>
    .slider-width500
    {
        width: 500px;
    }
</style>

</head>

<body>
<h2>HdrHistogram Plotter</h2>

<input type="file" id="files" name="files[]" multiple />

<pre id="fileDisplayArea">Please select file(s) above.</pre>

<!--Div that will hold the chart-->
<div id="chart_div">None Loaded</div>

Latency time units:
<select name="units" size="1" id="timeUnitSelection" onChange="timeUnitsSelected()">
    <option value="Latency (seconds)">seconds</option>
    <option selected value="Latency (milliseconds)">milliseconds</option>
    <option value="Latency (µs)">microseconds</option>
    <option value="Latency (nanoseconds)">nanoseconds</option>
</select>
<button type='button' onclick='doExport(event)'>Export Image</button>

&nbsp; &nbsp; &nbsp; &nbsp;
<p>
Percentile range:

<input type="range" class="slider-width500"
       min="1" max="8" value="3" step="1"
       width="300px"
       onchange="showValue(this.value)" />
<span id="percentileRange">99.9%</span>
<script type="text/javascript">
    function showValue(newValue) {
        var x = Math.pow(10, newValue);
        var percentile = 100.0 - (100.0 / x);
        document.getElementById("percentileRange").innerHTML=percentile + "%";
        maxPercentile = x;
        drawChart();
        return {typed: ''};
    }
</script>
</p>
<p>
    <br>
*** Note: Input files are expected to be in the .hgrm format produced by
HistogramLogProcessor, or the percentile output format for HdrHistogram.
See example file format
    <a href="https://github.com/HdrHistogram/HdrHistogram/blob/master/GoogleChartsExample/example1.txt">here</a>
</p>
<!--<h4>Expected Service Level:</h4>-->
<!--<input type="checkbox" name="ESL" value="ESL">Plot Expected Service Level<br>-->
<!--Percentile:-->
<!--<input type="text" id="ESLPercentile0" name="ESLPercentile0" size="6" value = 90 />-->
<!--% &nbsp &nbsp &nbsp Limit:-->
<!--<input type="text" id="ESLLimit0" name="ESLLimit0" size="12"/>-->
<!--<br>-->
<!--Percentile:-->
<!--<input type="text" id="ESLPercentile1" name="ESLPercentile1" size="6" value = 99 />-->
<!--% &nbsp &nbsp &nbsp Limit:-->
<!--<input type="text" id="ESLLimit1" name="ESLLimit1" size="12"/>-->
<!--<br>-->
<!--Percentile:-->
<!--<input type="text" id="ESLPercentile2" name="ESLPercentile2" size="6" value = 99.99 />-->
<!--% &nbsp &nbsp &nbsp Limit:-->
<!--<input type="text" id="ESLLimit2" name="ESLLimit2" size="12"/>-->
<!--<br>-->
<!--Percentile:-->
<!--<input type="text" id="ESLPercentile3" name="ESLPercentile2" size="6" value="100.0" readonly/>-->
<!--% &nbsp &nbsp &nbsp Limit:-->
<!--<input type="text" id="ESLLimit3" name="ESLLimit2" size="12"/>-->

<div id="data_1" class="histo">
  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

     491.519     0.000000            1         1.00
     516.351     0.100000           30         1.11
     519.935     0.200000           59         1.25
     522.495     0.300000           88         1.43
     524.799     0.400000          117         1.67
     529.407     0.500000          145         2.00
     537.087     0.550000          161         2.22
     540.159     0.600000          177         2.50
     541.695     0.650000          191         2.86
     542.719     0.700000          205         3.33
     543.743     0.750000          221         4.00
     544.255     0.775000          231         4.44
     544.767     0.800000          237         5.00
     545.279     0.825000          241         5.71
     545.791     0.850000          248         6.67
     546.303     0.875000          257         8.00
     546.815     0.887500          263         8.89
     546.815     0.900000          263        10.00
     547.327     0.912500          265        11.43
     547.839     0.925000          271        13.33
     548.351     0.937500          272        16.00
     549.375     0.943750          274        17.78
     549.887     0.950000          277        20.00
     550.399     0.956250          279        22.86
     550.911     0.962500          281        26.67
     550.911     0.968750          281        32.00
     551.935     0.971875          282        35.56
     552.959     0.975000          283        40.00
     555.007     0.978125          285        45.71
     555.007     0.981250          285        53.33
     561.151     0.984375          286        64.00
     561.151     0.985938          286        71.11
     564.223     0.987500          287        80.00
     564.223     0.989062          287        91.43
     565.247     0.990625          288       106.67
     565.247     0.992188          288       128.00
     565.247     0.992969          288       142.22
     566.783     0.993750          289       160.00
     566.783     0.994531          289       182.86
     566.783     0.995313          289       213.33
     566.783     0.996094          289       256.00
     566.783     0.996484          289       284.44
     567.295     0.996875          290       320.00
     567.295     1.000000          290          inf
#[Mean    =      531.517, StdDeviation   =       13.835]
#[Max     =      566.784, Total count    =          290]
#[Buckets =           27, SubBuckets     =         2048]
</div>

<div id="data_2" class="histo">
  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

     698.367     0.000000            1         1.00
     732.671     0.100000          151         1.11
     742.911     0.200000          312         1.25
     749.567     0.300000          452         1.43
     756.223     0.400000          603         1.67
     762.879     0.500000          755         2.00
     765.951     0.550000          828         2.22
     769.535     0.600000          906         2.50
     774.655     0.650000          983         2.86
     779.263     0.700000         1057         3.33
     784.895     0.750000         1132         4.00
     788.991     0.775000         1169         4.44
     792.575     0.800000         1208         5.00
     796.671     0.825000         1246         5.71
     802.815     0.850000         1282         6.67
     809.471     0.875000         1319         8.00
     812.543     0.887500         1338         8.89
     816.639     0.900000         1357        10.00
     820.735     0.912500         1374        11.43
     825.855     0.925000         1393        13.33
     834.559     0.937500         1411        16.00
     839.679     0.943750         1421        17.78
     842.239     0.950000         1432        20.00
     847.359     0.956250         1440        22.86
     855.039     0.962500         1449        26.67
     859.647     0.968750         1458        32.00
     865.791     0.971875         1464        35.56
     874.495     0.975000         1468        40.00
     878.079     0.978125         1473        45.71
     881.663     0.981250         1477        53.33
     895.487     0.984375         1482        64.00
     903.679     0.985938         1484        71.11
     912.383     0.987500         1487        80.00
     914.431     0.989062         1489        91.43
     919.551     0.990625         1491       106.67
     936.959     0.992188         1494       128.00
     937.983     0.992969         1495       142.22
     942.591     0.993750         1496       160.00
     953.855     0.994531         1497       182.86
     955.391     0.995313         1498       213.33
     962.559     0.996094         1500       256.00
     962.559     0.996484         1500       284.44
     975.359     0.996875         1501       320.00
     975.359     0.997266         1501       365.71
     977.919     0.997656         1502       426.67
     990.207     0.998047         1503       512.00
     990.207     0.998242         1503       568.89
     990.207     0.998437         1503       640.00
     990.207     0.998633         1503       731.43
     999.423     0.998828         1504       853.33
     999.423     0.999023         1504      1024.00
     999.423     0.999121         1504      1137.78
     999.423     0.999219         1504      1280.00
     999.423     0.999316         1504      1462.86
    1014.783     0.999414         1505      1706.67
    1014.783     1.000000         1505          inf
#[Mean    =      770.250, StdDeviation   =       39.104]
#[Max     =     1014.272, Total count    =         1505]
#[Buckets =           27, SubBuckets     =         2048]
</div>

<div id="data_3" class="histo">
  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

    1107.967     0.000000            1         1.00
    1488.895     0.100000          172         1.11
    1551.359     0.200000          343         1.25
    1600.511     0.300000          518         1.43
    1642.495     0.400000          687         1.67
    1682.431     0.500000          860         2.00
    1701.887     0.550000          943         2.22
    1726.463     0.600000         1029         2.50
    1747.967     0.650000         1113         2.86
    1773.567     0.700000         1198         3.33
    1800.191     0.750000         1284         4.00
    1817.599     0.775000         1330         4.44
    1828.863     0.800000         1369         5.00
    1844.223     0.825000         1412         5.71
    1865.727     0.850000         1456         6.67
    1884.159     0.875000         1498         8.00
    1898.495     0.887500         1520         8.89
    1916.927     0.900000         1542        10.00
    1935.359     0.912500         1563        11.43
    1950.719     0.925000         1583        13.33
    1969.151     0.937500         1605        16.00
    1980.415     0.943750         1615        17.78
    1999.871     0.950000         1627        20.00
    2008.063     0.956250         1637        22.86
    2025.471     0.962500         1647        26.67
    2060.287     0.968750         1659        32.00
    2067.455     0.971875         1663        35.56
    2076.671     0.975000         1669        40.00
    2093.055     0.978125         1675        45.71
    2103.295     0.981250         1681        53.33
    2113.535     0.984375         1685        64.00
    2119.679     0.985938         1687        71.11
    2134.015     0.987500         1692        80.00
    2138.111     0.989062         1694        91.43
    2140.159     0.990625         1695       106.67
    2166.783     0.992188         1698       128.00
    2174.975     0.992969         1699       142.22
    2185.215     0.993750         1701       160.00
    2187.263     0.994531         1702       182.86
    2191.359     0.995313         1704       213.33
    2199.551     0.996094         1705       256.00
    2199.551     0.996484         1705       284.44
    2215.935     0.996875         1706       320.00
    2224.127     0.997266         1708       365.71
    2224.127     0.997656         1708       426.67
    2224.127     0.998047         1708       512.00
    2224.127     0.998242         1708       568.89
    2226.175     0.998437         1709       640.00
    2226.175     0.998633         1709       731.43
    2226.175     0.998828         1709       853.33
    2303.999     0.999023         1710      1024.00
    2303.999     0.999121         1710      1137.78
    2303.999     0.999219         1710      1280.00
    2303.999     0.999316         1710      1462.86
    2303.999     0.999414         1710      1706.67
    2387.967     0.999512         1711      2048.00
    2387.967     1.000000         1711          inf
#[Mean    =     1692.396, StdDeviation   =      174.013]
#[Max     =     2385.920, Total count    =         1711]
#[Buckets =           27, SubBuckets     =         2048]
</div>

</body>
</html>
